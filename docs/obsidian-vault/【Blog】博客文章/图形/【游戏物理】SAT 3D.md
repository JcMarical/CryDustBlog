# 3D SAT问题
先扩展3D：2D的点就是边，变就是面。
2D SAT依靠边和边相交，就可以用分离轴判断了。而3D只是单纯依靠法线，就算重合也有可能不相交。


# 3D实现
完整流程：
- 面检测
- 面检测
- 边检测



1. 针对每一个边做叉乘(左x，右y)，得到全新的投影轴z，切面是xy面
2. 边检测：
	1. 遍历两个碰撞体所有的边和对
	2. 每一对判断是否在Minkowski形成一个支持面
	3. 如果形成支持面，计算投影距离。
	4. 选出投影距离最大的那一对边。

# 闵可夫斯基差（和）运算
- 差集如果包含到原点，即相交
- 


# 面和大平面--NativeFace/NativePlane
- 面:指三角形所在的面
- 大平面：指三角形所在的整个平面

平面方程：Normal（法线） · P（任意一点） = Offset（原点到平面的距离）

点到平面距离公式：
- dot(Normal, point) - offset;

某一点到平面的最近点：
point -  Distance（point） * normalize(Normal）；


# 空间变换
- 局部坐标变为世界坐标
从而在物理上实现碰撞体的相对变换。

# unsafe的作用


# 半边结构
- 一个边两个面用，怎么算？
- 根据边的顺序，选择一个，避免重复
存储
- 面环的上一个边的索引
- 面环的下一个边的索引
- 与此相对边的索引
- 该边所属面的索引
- 该边起点的顶点索引。

## Leak Detection
Unity自带内存泄漏的检测
- 比如没有写Dispose的函数


# NativeHull 凸包结构
- 定点数、面数、边数
- 顶点数组
- 面数组
- 平面数组
- 半边数组
【NativeDisableUnsafePtrRestriction】
- 面指针
- 平面指针
- 半边指针

标记：
- 是否已释放
- 是否已删除

Create函数
Dipose函数：创建了才允许释放


# 对比与判等的重载
需要继承Iquatable和ICompareable接口
- 

## 凸包建立
- 


# 过程
- 处理节点变化1：用一个字典存碰撞体的凸包们，根据全局id判断是否要重建
	- 拉取Unity的物体，
	- 判断重建
	- 重建所有getinstance为空的节点的凸包。 
- 处理凸包碰撞


# 基础Mesh收集

## 1. 主要流程
- 预处理顶点数据：限制浮点范围与舍入，使用Distinct（）去除重复顶点，生成**唯一顶点列表**
- 收集三角形**面信息**：
	- 遍历三角形索引数组
	- 提取三角形顶点，计算**法线**和**中心点**
	- 将这些信息构成DetailedFaceDef对象，加入面列表 faces
- **合并面**：
	- 通过法线进行分组
	- 再通过共享顶点进一步分组
	- 最终得到多个合并的**大面（plane）**
- 计算边界轮廓 & 识别孤立顶点
	- 收集所有顶点索引 
	- 提取边界顶点序列
	- 非边界识别为孤立顶点，记录索引
- 构建面定义结构
	- 每个合并面边界的索引转为数组
	- 记录最大顶点索引和顶点数量
	- 添加到**面数组**中
- 删除孤立顶点，修正索引
- 构建凸包
	- 创建两个NativeArray分别存储顶点和面数据
	- 构造凸包结构体，**SetFromFaces**方法构建出完整的**半边结构**的**凸包数据结构**
	- 设置初始化完成

## 2. SetFromFaces
根据顶点和面数据构造出完整的**半边结构**的**凸包数据结构**
- 初始化顶点数据：指针赋值给Vectieces
- 初始化面数据：所有面EDGE = -1，表示未连接
- 构建每个面的平面方程：
- 遍历每个面，构造半边数据：
	- 遍历**所有顶点边**
	- 构造当前边的**起始点v1和终点v2**
	- 使用（v1，v2）作为key，判断是否创建
	- 存在，说明共享，应该建立连接
	- 不存在，创建两个方向的半边e12和e21，初始化相关信息（当前面连接，另一面为连接）
- 为每个面记录半边索引列表
- 将每个面的**半边链表首位相连（有向循环链表）**
- 构建**边数组** ：将临时的edgesList写入到hull.edgesNative,并将GetUnsafePtr赋值给hull.edges


## 3. 最大索引是什么
- 代表这个面的最大顶点索引
- 表示这个面有可能包含受印象的索引

## 4. 计算逻辑是什么





# 核心检测方式

## 面检测
两个凸包相互检测一次

- 初始化最远距离
- 遍历当前凸包的所有面
	- 获取面的平面
	- 传入当前面的**反向法线**，获取指定方向的支持顶点Support。（因为目的是找到**最靠近**Hull1的点）
	- 计算**面到支撑点的距离**。
	- 碰撞结果：
		- 碰撞：两边算出的距离都小于0.
		- 分离轴存在：distance > 0
		- <=0,support落在了内侧或上面（重叠，需要继续检测其他轴）
	- 更新**最大距离**和**面索引**


## 边检测
- 计算候选分离轴（两条边的叉积）
- 判断是否平行，是则无效跳过处理
- 归一化分离轴向量
- 确保分离轴方向由第一个物体指向第二个物体（和法线点乘作比较，不符合就反转）
- 遍历边，判断是否构成闵可夫斯基支持面。
- 将两个边的起点在分离轴上作投影